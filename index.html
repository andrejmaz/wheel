<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–ª–µ—Å–æ —Ñ–æ—Ä—Ç—É–Ω—ã</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        var tg = window.Telegram?.WebApp;
    
        const initTelegramWebApp = () => {
          if (!tg || !tg.initDataUnsafe?.user) {
            console.log('–≠—Ç–æ –Ω–µ WebApp –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
            return;
          }
    
          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
          tg.expand();
          tg.ready();
          tg.enableClosingConfirmation();
    
          // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ü–≤–µ—Ç–æ–≤
          const setColor = (method, color) => {
            tg[method]?.(color) ||
              tg.postEvent?.(`web_app_set_${method}`, JSON.stringify({ color })) ||
              window.parent.postMessage(
                { eventType: `web_app_set_${method}`, eventData: { color } },
                '*'
              );
          };
    
          setColor("setHeaderColor", "#000");
          setColor("setBackgroundColor", "#000");
    
          // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —Å–≤–∞–π–ø–æ–≤
          if (tg.isVersionAtLeast && tg.isVersionAtLeast('7.7')) {
            tg.disableVerticalSwipes?.();
          } else {
            document.body.style.overflow = "hidden";
          }
    
          // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
          window.addEventListener('beforeunload', (e) => {
            e.preventDefault();
            e.returnValue = '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ?';
          });
    
          // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
          window.addEventListener('error', (e) => {
            console.error('–û—à–∏–±–∫–∞ –≤ WebApp:', e.message);
          });
        };
    
        const loadWheelContent = async () => {
          try {
            const response = await fetch('/webhook/wheel/check', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                tg_id: tg.initDataUnsafe.user.id,
                first_name: tg.initDataUnsafe.user.first_name,
                username: tg.initDataUnsafe.user.username,
                photo_url: tg.initDataUnsafe.user.photo_url,
              }),
            });
    
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
    
            const data = await response.json();
            if (data.html) {
              const wheelContainer = document.querySelector('.wheel-container');
              const loadDiv = document.querySelector('.load-container');
    
              // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
              wheelContainer.innerHTML = data.html;
    
              // –£–¥–∞–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏
              setTimeout(() => loadDiv.style.opacity = '0', 1000);
              setTimeout(() => loadDiv.remove(), 500);
            } else {
              throw new Error('HTML not found in the response.');
            }
          } catch (error) {
            console.error('Error:', error.message);
          }
        };
    
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        initTelegramWebApp();
        window.addEventListener('load', loadWheelContent);
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TweenMax.min.js"></script>
    <script src="/logicer.js"></script>
    <script src="logicerser.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Montserrat Alternates', sans-serif;
            background-color: #0D0D0D;
            color: #fff;
        }
    </style>
</head>
<body>


    <section id="wheel">
        <div class="the_wheel_title">
            <h1>–ö–æ–ª–µ—Å–æ <span class="accent-word">—Ñ–æ—Ä—Ç—É–Ω—ã</span></h1>
            <p>–ü–æ–¥–∞—Ä–∏—Ç–µ —Å–µ–±–µ –º–æ–º–µ–Ω—Ç —Ä–∞–¥–æ—Å—Ç–∏ ü§ó</p>
        </div>
        
        <div class="the_wheel">
            <div class="wheel-container">
                <canvas id="canvas" class="wheel-canvas" width="480" height="480" data-responsiveMinWidth="320" data-responsiveScaleHeight="true">
                <p style="color: white" align="center">–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç canvas.</p>
                </canvas>
            </div>
        </div>
        
        <div class="button-block">
            <button class="styled-button" onClick="startSpin();">–ò—Å–ø—ã—Ç–∞—Ç—å —É–¥–∞—á—É</button>
        </div>
        <style>
            /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–∫—Å—Ç–∞ */
            p, span, h1, h2, h3{
                color:#fff;
            }

            .the_wheel_title{
                margin: 20px 10px 40px 10px;
            }

            .the_wheel_title p,
            .the_wheel_title  h1 {
                font-family: Montserrat Alternates;
                text-align:center;
            }

            .accent-word{
                color:#1866F1;
            }

            /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–ª–µ—Å–∞ */
            .the_wheel {
                position: relative;
            }
            .the_wheel::after {
                content: "";
                position: absolute;
                top: -15px;
                left: calc(50% - 25px);
                width: 0; 
                height: 0;
                border-left: 25px solid transparent;
                border-right: 25px solid transparent;
                border-top: 50px solid #1866F1;
                -webkit-filter: drop-shadow(2px 2px 5px rgba(0,0,0,.5));
                filter: drop-shadow(2px 2px 5px rgba(0,0,0,.5));
                z-index: 2;
            }

            .wheel-container{
                display: flex;
                flex-direction: column;
                flex-wrap: nowrap;
                align-items: center;
            }

            canvas {
                width: 100%;
                max-width: 480px;
            }

            /* –ü—Ä–æ—á–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã */
            .button-block{
                display: flex;
                flex-direction: column;
                flex-wrap: nowrap;
                align-items: center;
            }

            .styled-button {
                background-color: #1866F1;
                color: #ffffff;
                border: none;
                border-radius: 8px;
                padding: 16px 54px;
                font-size: 16px;
                font-weight: bold;
                text-transform: uppercase;
                cursor: pointer;
                outline: none;
                transition: all 0.3s ease;
                margin: 30px 10px;
            }

            .styled-button:hover {
                background-color: #1846F1;
                transform: translateY(-4px);
                box-shadow: 0 6px 12px rgba(0,0,0,0.2);
            }

            .styled-button:active {
                background-color: #1846F1;
                transform: translateY(1px);
                box-shadow: 0 3px 6px rgba(0,0,0,0.2);
            }

            .styled-button:focus {
                outline: none;
            }
        </style>
    </section>

    <section id="wheel-no-access">
        <div class="the_wheel_no-accec">
            <div class="the_wheel_title">
                <h1><span class="accent-word">–ö–æ–ª–µ—Å–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ</span></h1><br>
                <p>–î–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —É—á–∞—Å—Ç–∏—è –ø—Ä–∏–æ–±—Ä–µ—Ç–∏—Ç–µ –ª—é–±–æ–π —Ç–æ–≤–∞—Ä –Ω–∞—à–µ–≥–æ –±—Ä–µ–Ω–¥–∞ ‚§µ</p>
            </div>
            
            <div class="button-block">
                <button class="styled-button" onclick="window.location.href='https://bronks.creatium.site/';">–û—Ç–∫—Ä—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω</button>
            </div>
            
            <div class="the_wheel_title">
                <p><i>1 —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –æ—Ç–∑—ã–≤ = 1 –≤—Ä–∞—â–µ–Ω–∏–µ</i></p>
            </div>
            
        </div>

            <style>
                #wheel-no-access{padding:0;}

                .the_wheel_no-accec {
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    min-height: 100vh;
                    text-align: center;
                    box-sizing: border-box;
                }

                p, span, h1, h2, h3{
                    color:#fff;
                }

                .the_wheel_title{
                    margin: 20px 10px;
                }

                .the_wheel_title p,
                .the_wheel_title  h1 {
                    font-family: Montserrat Alternates;
                    text-align:center;
                }

                span.accent-word{
                    color:#1866F1;
                }

                .button-block{
                    display: flex;
                    flex-direction: column;
                    flex-wrap: nowrap;
                    align-items: center;
                }

                .styled-button {
                    background-color: #1866F1;
                    color: #ffffff;
                    border: none;
                    border-radius: 8px;
                    padding: 16px 54px;
                    font-size: 16px;
                    font-weight: bold;
                    text-transform: uppercase;
                    cursor: pointer;
                    outline: none;
                    transition: all 0.3s ease;
                    margin: 20px 10px;
                }

                .styled-button:hover {
                    background-color: #1846F1;
                    transform: translateY(-4px);
                    box-shadow: 0 6px 12px rgba(0,0,0,0.2);
                }

                .styled-button:active {
                    background-color: #1846F1;
                    transform: translateY(1px);
                    box-shadow: 0 3px 6px rgba(0,0,0,0.2);
                }

                .styled-button:focus {
                    outline: none;
                }
            </style>
    </section>


    <script>
        let wheelOptions = {
            'numSegments'  : 10,
            /*'drawText'     : false,*/
            'drawMode'     : 'image',
            'imageOverlay' : true,
            /*'responsive'   : true,*/
            'lineWidth'    : 0,
            'strokeStyle'  : 'transparent',
            //'fillStyle'    : 'transparent',
            'textFillStyle': 'transparent',
            /*'textFontSize' : 10,
            'textFontWeight' : 400,
            'textFontFamily':'Montserrat',*/
            'outerRadius'  : 220,
            //'innerRadius'  : 30,         
            'innerStyle'   : 'white',  
            'segments'     :
            [
                {   'text'  : "iPhine 15 256 GB",
                },
                {   'text'  : "1000 —Ä—É–±–ª–µ–π –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω",
                },
                {   'text'  : "–î–∂–æ–≥–≥–µ—Ä—ã –∞—Ä—Ç.21520102",
                },
                {   'text'  : "5000 —Ä—É–±–ª–µ–π –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω",
                },
                {   'text'  : "–§—É—Ç–±–æ–ª–∫–∞ –∞—Ä—Ç.42243902",
                },
                {   'text'  : "500 —Ä—É–±–ª–µ–π –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω",
                },
                {   'text'  : "–ë–µ–π—Å–±–æ–ª–∞ –∞—Ä—Ç.88732046",
                },
                {   'text'  : "300 —Ä—É–±–ª–µ–π –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω",
                },
                {   'text'  : "–ë–µ–π—Å–±–æ–ª–∫–∞ –∞—Ä—Ç.31667351",
                },
                {   'text'  : "150 —Ä—É–±–ª–µ–π –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω",
                }
            ],
            'animation' :
            {
                'type'     : 'spinToStop',
                'duration' : 8,
                'spins'    : 8,
                'callbackFinished' : alertPrize
            },
            'pins' :    
            {
                'number'      : 10,
                'outerRadius' : 5,
                'margin'      : -5,
                'lineWidth'    : 2,
                'fillStyle'   : '#fff',
                'strokeStyle' : '#fff',
                'responsive' : true
            }
        };
        
        let wheelSpinning = false;
        
        let theWheel = new Winwheel(Object.assign(wheelOptions, {'canvasId': 'canvas'}));
        
        let theWheelImg = new Image();
        theWheelImg.onload = function() {
            theWheel.wheelImage = theWheelImg;
            theWheel.draw();
            /*setTimeout(function(){
                $(window).resize();
            }, 1000);*/
        }
        theWheelImg.src = "https://files.salebot.pro/uploads/file_item/file/192012/Wheel.png";
        theWheelImg.width = theWheelImg.height = 440;
        
        window.prizes = [
            {
                'sector': 1,
                'offerId': 1,
                'totalCnt': 0
            },
            {
                'sector': 2,
                'offerId': 2,
                'totalCnt': 300
            },
            {
                'sector': 3,
                'offerId': 3,
                'totalCnt': 350
            },
            {
                'sector': 4,
                'offerId': 4,
                'totalCnt': 50
            },
            {
                'sector': 5,
                'offerId': 5,
                'totalCnt': 400
            },
            {
                'sector': 6,
                'offerId': 6,
                'totalCnt': 700
            },
            {
                'sector': 7,
                'offerId': 7,
                'totalCnt': 600
            },
            {
                'sector':8,
                'offerId': 8,
                'totalCnt': 1000
            },
            {
                'sector': 9,
                'offerId': 9,
                'totalCnt': 500
            },
            {
                'sector': 10,
                'offerId': 10,
                'totalCnt': 6000
            }
        ];
        
        
        window.setPrizeCount = function (offerId, cnt) {
            console.log(offerId, cnt);
            for (let i = 0; i < prizes.length; i++) {
                if (window.prizes[i].offerId == offerId) {
                    window.prizes[i].totalCnt = window.prizes[i].totalCnt - cnt;
                    if (window.prizes[i].totalCnt < 0) {
                        window.prizes[i].totalCnt = 0;
                    }
                    break;
                }
            }
        }
        
        function getRandomIntInclusive(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        
        window.startSpin = function () {
            if (wheelSpinning == false) {
                wheelSpinning = true;
                let spin_prizes = [];
                for (let i = 0; i < window.prizes.length; i++) {
                    spin_prizes = spin_prizes.concat(Array(window.prizes[i].totalCnt).fill(window.prizes[i]));
                }
                console.log(spin_prizes);
                let prize = spin_prizes[getRandomIntInclusive(0, spin_prizes.length - 1)];
        
                theWheel.animation.stopAngle = theWheel.getRandomForSegment(prize.sector);
                theWheel.startAnimation();
            }
        }
        
        function alertPrize(indicatedSegment) {
            const sanitizedText = indicatedSegment.text.replace(/(\r\n|\n|\r)/gm, "");
            recordSpinTime();
            document.querySelector('.ml_quiz_free_answer').value = sanitizedText;
            document.querySelector('.send_quiz-btn')?.onclick();
        }
        
        function canSpinWheel() {
            const lastSpinTime = localStorage.getItem('lastSpinTime');
        
            if (lastSpinTime) {
                const lastSpinDate = new Date(lastSpinTime);
                const now = new Date();
        
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—à–ª–∏ –ª–∏ 10 –º–∏–Ω—É—Ç —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
                const tenMinutes = 10 * 60 * 1000; // 10 –º–∏–Ω—É—Ç –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
                if (now - lastSpinDate < tenMinutes) {
                    return false; // –ï—â—ë –Ω–µ –ø—Ä–æ—à–ª–æ 10 –º–∏–Ω—É—Ç
                }
            }
        
            return true; // –ú–æ–∂–Ω–æ –ø—Ä–æ–∫—Ä—É—Ç–∏—Ç—å
        }
        
        function recordSpinTime() {
            localStorage.setItem('lastSpinTime', new Date().toISOString());
        }
        
    </script>
</body>
</html>